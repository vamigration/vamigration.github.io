<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <script
    src="https://code.jquery.com/jquery-2.2.4.min.js"
    integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
    crossorigin="anonymous">
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/waypoints/4.0.1/jquery.waypoints.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.13.0/d3.js"></script>

  <script type="text/javascript" src="https://github.com/flowhub/the-graph/blob/master/the-graph/font-awesome-unicode-map.js"></script>


  <link rel="stylesheet" type="text/css" href="./css/style.css">
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.css">
</head>

<body>
  <div class="header sticky centered" id="myHeader">
    <h1><strong>Perception of migration on social media - U.S. vs U.K</strong><h1>
  </div>
  <div id="graphic">
  <div class="container">
    <div id="div1">
      <h1>Gathering data</h1>
      <h2>Each <strong>circle</strong> here represents <strong>100 tweets</strong> talking about <strong>migration</strong>-related topics</strong>. 
      </h2>
      <h2>We got these data to analyze the <strong>Perception of migration on social media</strong>.</h2>
      <br/>
      We looked for tweets in English, that were not re-tweets and that contained one of the following words: <strong>‘migrant’, ‘immigrant’, ‘refugee’ and ‘asylum seeker’.</strong>
      <br/>
      You can see 3510 circles, representing nearly 351000 collected tweets during the months of August, September and October 2019.

    </div>

    <div id="div2">
      <h1>Collected data</h1>

      <h2>We got enough data just for <strong>the United States of America (US)</strong> and <strong>United Kingdom (UK)</strong>.</h2>
      <br/>
      <p>In total, we got 251294 tweets for the U.S and 110.000 for the U.K. The numbers here are an approximation to properly represent the circles on the screen. However, the real distribution was kept.</p>

      <h2>It was expected to have a good amount of tweets from Canada and Australia. However, the topic seems to be relevant in countries like <strong>India, Indonesia, Germany </strong> and <strong> Nigeria</strong> as well, even when we considered just English written tweets.</h2>
    </div>

    <div id="div2_1">
      <h1>Engagement</h1>
      <h2>However, if we analyze it against the number of inhabitants in each country, we get that the United Kingdom has almost two times more engagement than users in the United States.</h2>
      <br>
      If any detail is required we are going to provide it here. But the info in the title should be enough to understand the graph on the right.
    </div>

    <div id="div3">
    <h1>Sentiment</h1>
     <h2>We then estimated the sentiment for all tweets using Vader and some other libraries.
     Each country has its particularities
     </h2>
     </div>

  <!--   <div id="div4">
      <h2>And we could go back to a grid I don't know what for but anyway<h2>
    </div> -->

   <div id="div5">
      <h1>Hashtags</h1>
      <h2>5. We looked for tweets in English, that were not re-tweets and that contained one of the following words: <strong>‘migrant’, ‘immigrant’, ‘refugee’ and ‘asylum seeker’.</strong></h2>
      <h2>This should be the fource layout. Delete all rects and barchart and then display the aggregated hashtags data</h2>
    </div>

    <div id="div6">
      <h2>6. Then we talk about hashtags and the general sentiment over them. Highlight the relevant things.</h2>
    </div>
    
    <div id="div7">
      <h2>7. And then we present some conclusions</h2>
    </div>
  </div>


  <!-- svg -->
  <div class="fixed"><svg id="viz" width="100%" height="100%"></svg></div>

</div><!-- /graphic -->
  
  
  <script>

var loadCircles = false; //switch the hashtags circles at each screen
let circles; // Reference to the hashtags circles
var ht_data;




d3.csv("./data/hashtags_d3.csv",
    function(d) {
        console.log("loaded")
        ht_data = d;

        ht_data = ht_data.map((i) => (new Array(i.num_points)).fill(i, 0, i.num_points)).reduce((acc, i) => acc.concat(i))
    });



$(window).load(function() {
  var data;
  d3.csv("./data/tweets_d3_1000.csv", function(d) {
      data = d;
      console.log(data)

      //data = datos.map((i) => (new Array(i.num_points)).fill(i, 0, i.num_points)).reduce((acc, i) => acc.concat(i));

      //svg
      let svg = d3.select("svg");

      //svg width and height
      svg.attr('width', 700)
        .attr('height', 640)

      //set up grid spacing
      let spacing = 8;
      let rows = 60;
      let column = 60;
      let size = 5;
      let randnum = (min, max) => Math.round(Math.random() * (max - min) + min);

      //Create an array of objects
      let our_data = d3.range(20).map(i =>
          ({
              'device': i < 5 ? 'ios' : 'android',
              'city': i < 3 ? 'San Diegan' : 'Out of towners',
              'age': randnum(25, 65)
          }));

      //create group and join our data to that group
      let group = svg.selectAll('g')
          .data(data)
          .enter()
          .append("g")


      //create rectangles
      let rects = group.append("rect")


      let sentiment_color = (tweet) => {
          if (tweet['sentiment'] == 'negative')
              return "#f44336";
          if (tweet['sentiment'] == 'neutral')
              return "#91989D";
          if (tweet['sentiment'] == 'positive')
              return "#66bb6a";
          return "#68DF82";

      }

      let country_color = (tweet, field) => {
        //var colorScale = ['orange', 'lightblue', '#B19CD9'];
        //"#99c125" : "#394147"
          if (tweet[field] == 'US')
              return "#5b6871";
          if (tweet[field] == 'UK')
              return "#67a9cf";
          return "orange";
      }

      // Text below the graphs (so far it's not being deleted from screen to screen)
        svg
          .append("text")
          .text('\uf099 ≈ 351000 tweets')
          .attr("fill", "#444")
          //.attr("text-anchor", "end")
          .attr("class", "fab")
          //.attr('font-weight', "900")
          //.attr('font-size', '40px')
          //.attr("dy", ".35em")
          .attr("x", 15)
          .attr("y", 575)
          //.attr("opacity", 1)
       
        svg.append("text")
          .text('\uf079 2 million retweets')
          .attr("fill", "#444")
          .attr("class", "fa")
          .attr("x", 190)
          .attr("y", 575)

        svg.append("text")
          .text('\uf004 5 million likes')
          .attr("fill", "#444")
          .attr("class", "fa")
          .attr("x", 400)
          .attr("y", 575)
        
        svg.append("text")
          .text('Each circle represents 100 tweets. Tweets were collected from Aug to Oct 2019')
          .attr("fill", "#444")
          .attr("class", "svg_text")
          .attr("x", 16)
          .attr("y", 598)



      // square grid
      let grid = () => {
        loadCircles = false;//switch off the hashtags
        clearText();

        //The semi circles
        rects
            .data(data)
            .attr("width", 0)
            .attr("height", 0)

            .attr("opacity", 0)
            .transition()
            .attr("width", size)
            .attr("height", size)
            .attr("rx", 4)
            .attr("ry", 4)
            .delay((d, i) => i)
            .duration((d, i) => 10)
            .attr("x", (d, i) => (i % column * spacing) + 45)
            .attr("y", (d, i) => (Math.floor(i / column) % rows * spacing) + 30)
            .attr("fill", "steelblue")
            .attr("opacity", 1)
      }


      function countryGrid(){

        loadCircles = false;//switch off the bubble hashtags
        clearText();
        addUSFlag(180, 530)
        addUKFlag(505, 530)
        let spacing = 6;
        let rows = 90;
        let column = 35;
        let size = 5;
        usX = 0;
        ukX = 0;
        usY = 0;
        ukY = 0;

        rects
            .transition()
            .delay((d, i) => i)
            .duration(200)
            //.ease("elastic")
            .attr("width", size)
            .attr("height", size)
            .attr("rx", 3)
            .attr("ry", 3)
            .attr("x", function (d, i) {
              if(d['country'] == 'US'){
                usX++;
                return ((usX-1) % column * spacing) + 60
              }
              else{
                ukX++;
                return ((ukX-1) % column * spacing) + 380
              }
            })
            .attr("y", function (d, i) {
              pos = 0;
              if(d['country']=='US'){
                pos = usY;
                usY++;
              }
              else{
                pos = ukY;
                ukY++;
              }
              return 500 - (Math.floor(pos / column) % rows * spacing)
            })
            .attr("fill", (d, i) => country_color(d, 'country'))
            .attr("opacity", 1) //only show 12 people

      }

      function countryPercentageGrid(){

        loadCircles = false;//switch off the bubble hashtags
        clearText();
        clearRects();
        addUSFlag(180, 530)
        addUKFlag(505, 530)
        let spacing = 4;
        let rows = 90;
        let column = 35;
        let size = 5;
        usX = 0;
        ukX = 0;
        usY = 0;
        ukY = 0;

        rects
            .transition()
            .delay((d, i) => i)
            .duration(200)
            //.ease("elastic")
            .attr("width", size)
            .attr("height", size)
            .attr("rx", 3)
            .attr("ry", 3)
            .attr("x", function (d, i) {
              if(d['proportion'] == 'US'){
                usX++;
                return ((usX-1) % column * spacing) + 60
              }
              else{
                ukX++;
                return ((ukX-1) % column * spacing) + 380
              }
            })
            .attr("y", function (d, i) {
              pos = 0;
              if(d['proportion']=='US'){
                pos = usY;
                usY++;
              }
              else{
                pos = ukY;
                ukY++;
              }
              return 500 - (Math.floor(pos / column) % rows * spacing)
            })
            .attr("fill", (d, i) => country_color(d, 'proportion'))
            .attr("opacity", 1) //only show 12 people

      }

      function sentimentGrid(){
        loadCircles = false;//switch off the bubble hashtags
        clearRects();
        clearText();
        addUSFlag(180, 530)
        addUKFlag(505, 530)
        let sentiment_shift = (tweet) => {
          if (tweet['sentiment'] == 'negative')
              return 20;
          if (tweet['sentiment'] == 'neutral')
              return 90;
          if (tweet['sentiment'] == 'positive')
              return 160;
          return 60;

        }
        sentimentUSX = {'negative': 0, 'neutral': 0, 'positive': 0}
        sentimentUKX = {'negative': 0, 'neutral': 0, 'positive': 0}
        sentimentUSY = {'negative': 0, 'neutral': 0, 'positive': 0}
        sentimentUKY = {'negative': 0, 'neutral': 0, 'positive': 0}

        let spacing = 5;
        let rows = 100;
        let column = 13;
        let size = 4;

        rects
            .transition()
            .delay((d, i) => i)
            .duration(200)
            //.ease("elastic")
            .attr("width", size)
            .attr("height", size)
            .attr("rx", "50%")
            .attr("ry", "50%")
            .attr("x", function (d, i) {
              if(d['country'] == 'US'){
                sentimentUSX[d['sentiment']]++;
                return ((sentimentUSX[d['sentiment']]-1) % column * spacing) + 35 + sentiment_shift(d)
              }
              else{
                sentimentUKX[d['sentiment']]++;
                return ((sentimentUKX[d['sentiment']]-1) % column * spacing) + 355 + sentiment_shift(d)
              }
            })
            .attr("y", function (d, i) {
              pos = 0;
              if(d['country']=='US'){
                pos = sentimentUSY[d['sentiment']];
                sentimentUSY[d['sentiment']]++;
              }
              else{
                pos = sentimentUKY[d['sentiment']];
                sentimentUKY[d['sentiment']]++;
              }
              return 500 - (Math.floor(pos / column) % rows * spacing)
            })
            .attr("fill", (d, i) => sentiment_color(d))
            .attr("opacity", 1) //only show 12 people

      }

      //sentiment circle grid (to be deleted)
      let circleGrid = () => {
          loadCircles = false;//switch off the hashtags
          clearRects();
          clearText();   

          rects
              .data(data)
              .transition()
              .delay((d, i) => i)
              .duration(200)
              //.ease("elastic")
              .attr("width", size)
              .attr("height", size)
              .attr("rx", "50%")
              .attr("ry", "50%")
              .attr("x", (d, i) => (i % column * spacing) + 45)
              .attr("y", (d, i) => (Math.floor(i / column) % rows * spacing) + 30)
              .attr("fill", (d, i) => (sentiment_color(d)))
              .attr("opacity", "1")

      }

      function clearRects(){
        rects
            .transition()
            .delay((d, i) => i)
            .duration(10)
            //.ease("elastic")
            .attr("opacity", "0");

        svg.selectAll('.grids')
          .transition()
          .delay((d, i) => i)
          .duration(10)
          //.ease("elastic")
          .attr("opacity", "0")
          .remove();

        svg.selectAll('.UK')
          .transition()
          .delay((d, i) => i)
          .duration(10)
          //.ease("elastic")
          .attr("opacity", "0")
          .remove();

        svg.selectAll('.US')
          .transition()
          .delay((d, i) => i)
          .duration(10)
          //.ease("elastic")
          .attr("opacity", "0")
          .remove();


      }

      function switchCircles(visible){
        if (visible) {
      
                circles
                    .transition()
                    .delay((d, i) => 12 * i)
                    .duration(100)
                    .attr("opacity", 1)
                
            } else {
                circles
                    .transition()
                    .delay((d, i) => 12 * i)
                    .duration(100)
                    .attr("opacity", 0)
            }

      }

      function clearText(){
        //country name
          d3.selectAll('text.num_tweets')
              .transition()
              .delay((d, i) => 2 * i)
              .duration(100)
              //.ease('elastic')
              .attr("dx", -500)


          //number of tweets
          d3.selectAll('.country')
              .transition()
              .delay((d, i) => 2 * i)
              .duration(100)
              //.ease('elastic')
              .attr("opacity", 0)
          d3.selectAll('.arrows')
            .transition()
            .delay((d,i)=> 2 * i)
            .duration(100)
            .attr("opacity", 0)

          d3.selectAll('.flag')
            .transition()
            .delay((d,i)=> 2 * i)
            .duration(100)
            .attr("opacity", 0)
      
      }

      //force layout
      let maytheforce = () => {

        clearRects(); // Remove the rects from previous frame
        clearText(); // Clear the text from previous frames
        addUSFlag(160, 420)
        addUKFlag(530, 420)
        loadCircles = true;

        var width = 600,
            height = 400;

        var colorScale = ['orange', 'lightblue', '#B19CD9'];
        //var xCenter = [10, 200, 400]
        var dictColor = {
            'US': '#5b6871',
            'UK': 'lightblue'
        };
        var dict = {
            'US': 140,
            'UK': 500
        };
        var dictY = {
            'US': 280,
            'UK': 280
        };
        

        var xCenter = d3.scaleLinear()
            .domain([1, 1305])
            .range([10, 50]);

        //set up grid spacing
        let spacing = 14;
        let rows = 40;
        let column = 40;
        let size = 8;
        let randnum = (min, max) => Math.round(Math.random() * (max - min) + min);

        var simulation = d3.forceSimulation(ht_data)
            .force('charge', d3.forceManyBody().strength(1))
            .force('x', d3.forceX().x(function(d) {
                return country_color(d, 'country');
            }))
            .force('collision', d3.forceCollide().radius(function(d) {
                return xCenter(d.num_tweets);
            }))
            .on('tick', ticked);



        function ticked() {

            circles = d3.select('svg g')
                .selectAll('circle')
                .data(ht_data);

            circles.enter()
                .append('circle')
                .attr('r', function(d) {
                    return xCenter(d.num_tweets);
                })
                .style('fill', function(d) {
                    return country_color(d, 'country');
                })
                .merge(circles)
                .attr('cx', function(d) {
                    return d.x;
                })
                .attr('cy', function(d) {
                    return d.y;
                })

            switchCircles(loadCircles);
            //circles.exit().remove();
          }
          simulation.force('x', d3.forceX().x(function(d) {
              return dict[d.country];
          }));
          simulation.force('y', d3.forceY().y(function(d) {
              return dictY[d.country];
          }));

      }

      let scale_x = d3.scaleLinear().domain([0, 1500])
          .range([5, 600]);

      let scale_y = d3.scaleLinear().domain([0, 120])
          .range([60, 600]);



      function drawBars(data, itemClass, shift){

        loadCircles = false;//switch off the hashtags
        //create rectangles
        let bars = group.append("rect")

          //country name
          d3.selectAll('g')
              .data(data)
              .append("text")
              .text((d) => d["hashtag"])
              .attr("fill", "#000")
              .attr("class", itemClass)
              //.attr("text-anchor", "end")
              .attr("dx", (d, i) => scale_x(d["num_tweets"]) + 12)
              .attr("dy", (d, i) => scale_y(i * 4) + 12 + shift)
              .attr("opacity", (d, i) => i < 12 ? 1 : 0) //only show 12 people

          //number of tweets data
          d3.selectAll('g')
              .data(data)
              .append("text")
              .text((d) => d["num_tweets"])
              .attr("fill", "#FFF")
              .attr("class", itemClass)
              .attr("text-anchor", "start")
              .attr("dx", 13)
              .attr("dy", (d, i) => scale_y(i * 4) + 11 + shift)
              .attr("opacity", (d, i) => i < 12 ? 1 : 0) //only show 12 people

          bars
              .data(data)
              .transition()
              .delay((d, i) => 10 * i)
              .duration(800)
              //.ease('elastic')//linear, quad, cubic, sin, exp, circle, elastic, back, bounce
              .attr("class", itemClass)
              .attr("rx", 0)
              .attr("ry", 0)
              .attr("x", (d, i) => 10)
              .attr("y", (d, i) => scale_y(i * 4) + shift)
              .attr("width", (d, i) => scale_x(d["num_tweets"]))
              .attr("height", (d, i) => 15)
              .attr("fill", (d, i) => country_color(d, 'country'))
                //(d['sentiment'] == "negative" ? "#99c125" : "#5b6871"))
              .attr("opacity", 1)
              .attr("transform", "translate(0,0) rotate(0)")
              .attr("opacity", (d, i) => i < 12 ? 1 : 0) //only show 12 people

      }

      //bar cart
      let barChart = function(country) {
          loadCircles = false //switch off the hashtags
          clearRects();
          clearText();
          const dataUK = ht_data.filter(d => d.country == 'UK');
          const dataUS = ht_data.filter(d=> d.country == 'US');
          
          drawBars(dataUK, 'UK', 250);
          drawBars(dataUS, 'US', 0);
          //drawBars(dataUK, 'UK', 200);
          //.exit().attr("opacity1", 0);

          
        //arrow
        svg.append("svg:defs").append("svg:marker")
          .attr("id", "triangle")
          .attr("refX", 6)
          .attr("refY", 6)
          .attr("markerWidth", 30)
          .attr("markerHeight", 30)
          .attr("markerUnits","userSpaceOnUse")
          .attr("orient", "auto")
          .append("path")
          .attr("d", "M 0 0 12 6 0 12 3 6")
          .style("fill", "#777");
    
        //line              
        svg.append("line")
            .attr("x1",  10)
            .attr("y1", 303)
            .attr("x2", 650)
            .attr("y2", 303)
            .attr("stroke-width", 1)
            .attr("stroke", "#777")
            .attr("class", "arrows")
            .attr("marker-end", "url(#triangle)");

        svg.append("text")
          .text('Number of tweets')
          .attr("fill", "#777")
          .attr("x", 560)
          .attr("y", 298)
          .attr("class", "arrows");

        //line              
        svg.append("line")
            .attr("x1",  10)
            .attr("y1", 53)
            .attr("x2", 650)
            .attr("y2", 53)
            .attr("stroke-width", 1)
            .attr("stroke", "#777")
            .attr("class", "arrows")
            .attr("marker-end", "url(#triangle)");

        svg.append("text")
          .text('Number of tweets')
          .attr("fill", "#777")
          .attr("x", 560)
          .attr("y", 48)
          .attr("class", "arrows");
          addUSFlag(400, 47);
          addUKFlag(400, 297);
      }

      function addUSFlag(x, y){
        svg.append("text")
        .attr("font-weight", "bold")
        .attr("font-size", "25px")
        .attr("x", x)
        .attr("y", y)
        .attr("class", "fa flag")
        .text(String.fromCodePoint(parseInt('1f1fa', 16), parseInt('1f1f8', 16)) + 'US')
        .attr("font-family", "sans-serif")
        .attr("text-anchor", "end");
      }

      function addUKFlag(x, y){
         svg.append("text")
        .attr("font-weight", "bold")
        .attr("font-size", "25px")
        .attr("x", x)
        .attr("y", y)
        .attr("class", "fa flag")
        .text(String.fromCodePoint(parseInt('1f1ec', 16), parseInt('1f1e7', 16)) + 'UK')
        .attr("font-family", "sans-serif")
        .attr("text-anchor", "end");
      }

      //waypoints scroll constructor
      function scrollD(n, offset, func1, func2, param) {

          return new Waypoint({
              element: document.getElementById(n),
              handler: function(direction) {
                  direction == 'down' ? func1(param) : func2(param);
              },
              //start 75% from the top of the div
              offset: offset
          });
      };

      //triger these functions on page scroll
      //new scroll('div1', '75%', grid, maytheforce);
      new scrollD('div1', '75%', grid, grid);
      new scrollD('div2', '75%', countryGrid, grid);
      new scrollD('div2_1', '75%', countryPercentageGrid, countryGrid);
      new scrollD('div3', '75%', sentimentGrid, countryPercentageGrid);
      //new scrollD('div4', '75%', circleGrid, sentimentGrid);
      new scrollD('div5', '75%', maytheforce, sentimentGrid, 'UK');
      new scrollD('div6', '75%', barChart, maytheforce, 'US');
      //new scroll('div6', '75%', barChart, divide, 'UK');
      //start grid on page load


  });

});

  </script>
</body>